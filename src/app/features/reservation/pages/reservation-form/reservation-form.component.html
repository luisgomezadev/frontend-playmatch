<app-layout
  [title]="'Hacer reserva'"
  [subtitle]="'Llena el formulario para programar una nueva reserva.'">
  <div actions>
    <app-button
      text="Volver"
      icon="fa-solid fa-arrow-left"
      [hasIcon]="true"
      color="transparent"
      (clicked)="goBack()"></app-button>
  </div>
  <div class="grid grid-cols-1 md:grid-cols-6 gap-6 w-full">
    <article
      class="bg-white/5 p-6 rounded-md shadow-md space-y-6 w-full col-span-1 md:col-span-4 md:h-[368px]"
      [formGroup]="formReservation">
      <h2 class="text-xl font-medium tracking-wide text-gray-200">
        Selecciona la fecha a reservar
      </h2>

      <div class="mb-4">
        <div
          class="flex overflow-x-auto gap-3 pb-2 [&::-webkit-scrollbar]:h-2 [&::-webkit-scrollbar-track]:bg-neutral-700/10 [&::-webkit-scrollbar-thumb]:bg-neutral-500 [&::-webkit-scrollbar-thumb]:rounded-full">
          @for (day of next20Days; track $index) {
            <button
              (click)="selectDate(day)"
              class="flex flex-col items-center p-3 sm:p-6 rounded-lg border transition-all min-w-36 select-none"
              [ngClass]="
                selectedDate?.getTime() === day.date.getTime()
                  ? 'bg-primary/80 text-white border-primary'
                  : 'bg-transparent text-gray-200 border-gray-500 hover:bg-primary/10 hover:border-primary hover:text-white'
              ">
              <span class="text-sm sm:text-lg capitalize text-center">{{ day.weekday }}</span>
              <span class="text-3xl sm:text-4xl font-bold text-center">{{ day.dayNumber }}</span>
              <span class="text-sm sm:text-lg capitalize text-center">{{ day.monthName }}</span>
            </button>
          }
        </div>
      </div>
      <p class="text-gray-300">
        <span class="text-primary">Importante:</span>
        Solo puedes reservar máximo 3 horas y tienen que ser consecutivas.
      </p>
      <footer class="flex justify-between gap-4 items-center">
        <div>
          @if (selectedHours.length > 0) {
            <span class="text-xs md:text-sm text-gray-400">
              Reserva de
              {{ selectedHours[0].start }} a {{ selectedHours[selectedHours.length - 1].end }}
            </span>
          } @else {
            <span class="text-xs md:text-sm text-gray-400">
              <i class="fa-solid fa-circle-exclamation text-yellow-600"></i>
              No has seleccionado ninguna hora
            </span>
          }
        </div>

        <app-button
          text="Hacer reserva"
          color="primary"
          [disabled]="loadingHours"
          [loading]="loading"
          (clicked)="verifyReservation()"></app-button>
      </footer>
    </article>
    <article
      class="bg-white/5 p-6 rounded-md shadow-md space-y-6 w-full col-span-1 md:col-span-2 overflow-y-auto max-h-60 md:max-h-[368px] [&::-webkit-scrollbar]:w-2 [&::-webkit-scrollbar-track]:bg-neutral-700/10 [&::-webkit-scrollbar-thumb]:bg-neutral-500 [&::-webkit-scrollbar-thumb]:rounded-full"
      [formGroup]="formReservation">
      <h2 class="text-xl font-medium tracking-wide text-gray-200">Horas disponibles</h2>
      @if (loadingHours) {
        <div class="flex justify-center items-center h-32">
          <i class="fa-solid fa-spinner fa-spin text-gray-300 text-2xl"></i>
        </div>
      } @else if (availableHours.length === 0) {
        <div class="text-gray-400">
          <i class="fa-solid fa-circle-exclamation text-yellow-600"></i>
          No hay horas disponibles para la fecha seleccionada.
        </div>
      } @else {
        <div class="grid grid-cols-1 gap-5">
          <button
            *ngFor="let h of availableHours"
            (click)="toggleHourSelection(h)"
            class="px-1 py-1.5 rounded-lg transition border w-full text-base font-medium"
            [ngClass]="{
              'bg-primary/10 text-primary border-primary': selectedHours.includes(h),
              'bg-transparent text-gray-300 border-gray-300 hover:border-white hover:bg-white/20':
                !selectedHours.includes(h)
            }">
            {{ h.start }} a {{ h.end }}
          </button>
        </div>
      }
    </article>

    <article class="bg-white/5 p-6 rounded-md shadow-md space-y-6 w-full col-span-1 md:col-span-6">
      <app-field-info [field]="field" />
    </article>
  </div>
</app-layout>
<app-modal [open]="isOpen()" (closed)="onClosed()" [title]="'Resumen de reserva'">
  @if (confirmedReservation) {
    <div class="space-y-6 text-gray-300">
      <div class="flex items-center gap-2">
        <i class="fa-solid fa-futbol text-primary"></i>
        <div>
          <span class="font-medium tracking-wide">Cancha:</span>
          {{ confirmedReservation.field?.name }}
        </div>
      </div>
      <div class="flex items-center gap-3">
        <i class="fa-regular fa-calendar text-primary"></i>
        <div>
          <span class="font-medium tracking-wide">Fecha:</span>
          {{ confirmedReservation.reservationDate }}
        </div>
      </div>
      <div class="flex items-center gap-3">
        <i class="fa-regular fa-clock text-primary"></i>
        <div>
          <span class="font-medium tracking-wide">Hora inicio:</span>
          {{ confirmedReservation.startTime | timeFormat }}
        </div>
      </div>
      <div class="flex items-center gap-3">
        <i class="fa-regular fa-clock text-primary"></i>
        <div>
          <span class="font-medium tracking-wide">Hora fin:</span>
          {{ confirmedReservation.endTime | timeFormat }}
        </div>
      </div>
      <div class="flex items-center gap-3">
        <i class="fa-solid fa-hourglass-half text-primary"></i>
        <div>
          <span class="font-medium tracking-wide">Duración:</span>
          {{ confirmedReservation.hours }} hora(s)
        </div>
      </div>
    </div>
  }

  <div class="pt-6 flex gap-3">
    <app-button
      text="Confirmar reserva"
      color="primary"
      (clicked)="confirmReservation()"></app-button>
    <app-button text="Cancelar" color="red" (clicked)="cancelReservation()"></app-button>
  </div>
</app-modal>

@if (loadingReservation) {
  <app-loading-component text="Creando reserva, espere un momento..." />
}
